<div class="box">
  <h1>Trilha Morro da Mesa</h1>
  <h2>23 de Novembro - Trilheiros de Rondonópolis</h2>

  <div id="alertaLotado" style="display:none;">⚠️ Grupo lotado! As 75 vagas foram preenchidas.</div>

  <textarea readonly>
- O percurso tem nível médio a avançado, com trechos íngremes e escorregadios.
- É obrigatório o uso de calçados adequados, água, protetor solar e roupas confortáveis.
- É proibido o uso de caixas de som para preservar o ambiente.
- O participante deve respeitar a natureza, não deixar lixo e seguir as orientações do guia.
- A organização não se responsabiliza por acidentes causados por imprudência ou desrespeito às regras.
- Em caso de condições climáticas adversas, o passeio poderá ser cancelado ou adiado.
- É indispensável estar em boas condições de saúde para participar da trilha.
- Pessoas com problemas cardíacos, respiratórios, mobilidade reduzida ou com histórico de desmaios/síncopes não são orientadas a realizar esta atividade.
- Participantes sedentários ou sem preparo físico devem avaliar cuidadosamente os riscos antes de confirmar presença.
- Crianças menores de 14 anos não serão permitidas.
  </textarea>

  <label for="nome">Nome completo</label>
  <input type="text" id="nome" placeholder="Digite seu nome completo">

  <label>
    <input type="checkbox" id="aceite"> Confirmo que li e aceito o termo de responsabilidade
  </label>

  <button id="entrarBtn" disabled>
    Entrar no grupo do WhatsApp
  </button>

  <div id="mensagemErro" style="color:red; margin-top:5px;"></div>
</div>

<script>
const JOIN_LINK = "https://chat.whatsapp.com/GOReIoh8N0ZCa4pQh2IMy7";
const MAX_PARTICIPANTES = 75;
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzK_Y9HAHMFqZBQAhEWjmJH5pdIYD2-Z9n4irlu7O0_/dev";

const nomeInput = document.getElementById("nome");
const aceite = document.getElementById("aceite");
const botao = document.getElementById("entrarBtn");
const alerta = document.getElementById("alertaLotado");
const mensagemErro = document.getElementById("mensagemErro");

function validar() {
    const nomeOk = nomeInput.value.trim().length > 3;
    const aceito = aceite.checked;
    botao.disabled = !(nomeOk && aceito);
}

nomeInput.addEventListener("input", validar);
aceite.addEventListener("change", validar);

async function verificarStatus() {
    try {
        const r = await fetch(WEBAPP_URL);
        const data = await r.json();

        if (data.total >= MAX_PARTICIPANTES) {
            botao.disabled = true;
            alerta.style.display = "block";
            mensagemErro.textContent = "Infelizmente o grupo já atingiu o limite de participantes.";
        } else {
            alerta.style.display = "none";
            mensagemErro.textContent = "";
            validar(); // reativa o botão se ainda houver vagas
        }
    } catch (e) {
        console.log("Erro ao verificar limite", e);
    }
}

botao.addEventListener("click", async () => {
    if (botao.disabled) return;

    const nome = nomeInput.value.trim();

    try {
        const resp = await fetch(WEBAPP_URL, {
            method: "POST",
            body: new URLSearchParams({ nome })
        });

        const resultado = await resp.json();

        if (resultado.erro === "duplicado") {
            mensagemErro.textContent = "Este nome já está inscrito.";
            return;
        }

        // Abre o link do WhatsApp sem mostrar no HTML
        window.location.href = JOIN_LINK;

    } catch (e) {
        mensagemErro.textContent = "Erro ao enviar dados. Tente novamente.";
    }
});

// Checar status ao carregar e a cada 30 segundos
verificarStatus();
setInterval(verificarStatus, 30000);
</script>
